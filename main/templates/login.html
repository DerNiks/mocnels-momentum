{% extends 'base.html' %}

{% block meta %}
<title>Login - Mocnels Momentum</title>
{% endblock meta %}

{% block content %}
<div class="w-full min-h-screen flex items-center justify-center p-6">
  <div class="max-w-md w-full">
    <!-- Card -->
    <div class="bg-white border border-gray-200 rounded-2xl shadow-sm p-6 sm:p-8 login-card">

      <!-- Heading -->
      <div class="text-center mb-8">
        <a href="{% url 'main:show_main' %}" class="inline-flex items-center justify-center gap-2 mb-3">
          <span class="text-xl font-semibold">
            <span class="text-green-600">Mocnels</span> <span class="text-gray-900">Momentum</span>
          </span>
        </a>
        <h1 class="text-2xl font-bold text-gray-900">Sign In</h1>
        <p class="text-gray-600 mt-1">Welcome back to Mocnels Momentum</p>
      </div>

      <!-- Non-field errors -->
      {% if form.non_field_errors %}
        <div class="mb-4">
          {% for error in form.non_field_errors %}
            <div class="px-4 py-3 rounded-md text-sm border bg-red-50 border-red-200 text-red-700">
              {{ error }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- Field errors -->
      {% if form.errors %}
        <div class="mb-4">
          {% for field, errors in form.errors.items %}
            {% if field != '__all__' %}
              {% for error in errors %}
                <div class="px-4 py-3 rounded-md text-sm border bg-red-50 border-red-200 text-red-700 mb-2">
                  <strong>{{ field|title }}:</strong> {{ error }}
                </div>
              {% endfor %}
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

      <!-- Form -->
      <form method="POST" action="" class="space-y-5">
        {% csrf_token %}

        <!-- Username -->
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username</label>
          <div class="relative">
              <span class="input-icon-left">
              <svg class="input-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5Zm0 2c-4.418 0-8 2.239-8 5v1h16v-1c0-2.761-3.582-5-8-5Z"/></svg>
            </span>
            <input
              id="username"
              name="username"
              type="text"
              required
              autocomplete="username"
              class="w-full pl-10 pr-3 py-3 rounded-lg border border-gray-300 focus:outline-none focus:border-green-500 transition-colors"
              placeholder="Enter your username">
          </div>
        </div>

        <!-- Password -->
        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
          <div class="relative">
            <span class="input-icon-left">
              <svg class="input-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M17 9h-1V7a4 4 0 0 0-8 0v2H7a2 2 0 0 0-2 2v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2v-7a2 2 0 0 0-2-2Zm-7-2a2 2 0 1 1 4 0v2H10ZM12 14a2 2 0 0 0-1 3.732V19h2v-1.268A2 2 0 0 0 12 14Z"/></svg>
            </span>
            <input
              id="password"
              name="password"
              type="password"
              required
              autocomplete="current-password"
              class="w-full pl-10 pr-10 py-3 rounded-lg border border-gray-300 focus:outline-none focus:border-green-500 transition-colors"
              placeholder="Enter your password">
            <button type="button" id="togglePw"
              class="absolute inset-y-0 right-0 px-3 text-gray-500 hover:text-gray-700"
              aria-label="Show password">
                <svg class="input-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5c-7 0-10 7-10 7s3 7 10 7 10-7 10-7-3-7-10-7Zm0 11a4 4 0 1 1 4-4 4 4 0 0 1-4 4Z"/></svg>
            </button>
          </div>
        </div>

        <!-- Submit -->
        <button type="submit"
          class="w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 transition-colors">
          Sign In
        </button>
      </form>

      <!-- Messages -->
      {% if messages %}
        <div class="mt-5 space-y-2">
          {% for message in messages %}
            <div class="px-4 py-3 rounded-md text-sm border
              {% if message.tags == 'success' %} bg-green-50 border-green-200 text-green-700
              {% elif message.tags == 'error' %} bg-red-50 border-red-200 text-red-700
              {% else %} bg-gray-50 border-gray-200 text-gray-700 {% endif %}">
              {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <!-- Divider + Register -->
      <div class="mt-8 pt-6 border-t border-gray-200 text-center">
        <p class="text-gray-500 text-sm">
          Don't have an account?
          <a href="{% url 'main:register' %}" class="text-green-600 hover:text-green-700 font-medium">
            Register Now
          </a>
        </p>
      </div>
    </div>
  </div>
</div>

<script>
  (function () {
    const btn = document.getElementById('togglePw');
    const input = document.getElementById('password');
    if (!btn || !input) return;
    btn.addEventListener('click', function () {
      const is = input.getAttribute('type') === 'password';
      input.setAttribute('type', is ? 'text' : 'password');
      this.setAttribute('aria-label', is ? 'Hide password' : 'Show password');
    });
  })();

document.getElementById('login-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const form = e.target;
    const submitBtn = document.getElementById('login-submit-btn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Signing In...';

    const formData = new FormData(form);
    const csrfToken = formData.get('csrfmiddlewaretoken') || getCSRFToken();
    
    try {
        const response = await fetch(form.action, {
            method: 'POST',
            headers: { 
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken
            },
            body: formData
        });

        const data = await response.json();
        
        if (response.ok) {
            showToast(data.message, 'success');
            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 1000); 
        } else {
            let errorMessageText = data.message || 'Login gagal.';
            if (response.status === 400 && data.errors && data.errors.non_field_errors) {
                errorMessageText = data.errors.non_field_errors.join(' ');
            }
            showToast(errorMessageText, 'error', 5000);
            document.getElementById('password').value = '';
        }

    } catch (error) {
        showToast('Kesalahan jaringan. Gagal terhubung ke server.', 'error', 5000);
    } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Sign In';
    }
});

</script>
{% endblock content %}
